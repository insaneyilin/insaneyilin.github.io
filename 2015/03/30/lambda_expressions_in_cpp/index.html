<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>C++ 中的 lambda 表达式 | Yilin&#39;s blog</title>
  <meta name="author" content="insaneguy">
  
  <meta name="description" content="This guy is insane.">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="C++ 中的 lambda 表达式"/>
  <meta property="og:site_name" content="Yilin&#39;s blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Yilin&#39;s blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Yilin&#39;s blog</a></h1>
  <h2><a href="/">This guy is insane.</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/about">About</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-03-30T14:56:29.000Z"><a href="/2015/03/30/lambda_expressions_in_cpp/">03-30-2015</a></time>
      
      
  
    <h1 class="title">C++ 中的 lambda 表达式</h1>
  

    </header>
    <div class="entry">
      
        <p>lambda 表达式是函数式编程语言中一个很 cool 的特性，而 C++11 标准加入了对 lambda 表达式的支持。本篇文章对 C++11 中的 lambda 表达式做一个简单的介绍。</p>
<p><br></p>
<hr>
<h2 id="什么是_lambda_表达式">什么是 lambda 表达式</h2>
<p>说到 <a href="http://en.wikipedia.org/wiki/Lambda_Calculus" target="_blank" rel="external">lambda expression</a> 就不能不提 lambda calculus，前者是从后者中衍生出的概念，lambda calculus 有着严格的数学定义，与<a href="http://en.wikipedia.org/wiki/Turing_machine" target="_blank" rel="external">图灵机</a>有着等价的计算能力。这里只介绍编程语言中的 lambda 表达式概念。</p>
<p>在函数式编程语言中，函数是一等公民。有时我们需要一个函数，但又不想要定义一个具有名字的函数，即我们需要一个<strong>匿名函数</strong>，而一个 lambda 表达式实际上就是通过表达式的方式定义了一个匿名函数。</p>
<a id="more"></a>

<h3 id="C++_中_lambda_表达式的语法规则">C++ 中 lambda 表达式的语法规则</h3>
<p>先通过一个简单的例子来看看 C++ 中 lambda 表达式的基本语法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;iostream&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">int</span> main()</div><div class="line">{</div><div class="line">    <span class="keyword">auto</span> foo = []() { <span class="built_in">cout</span> &lt;&lt; <span class="string">"Hello, Lambda!\n"</span>; };</div><div class="line">    foo();  <span class="comment">// call the function</span></div><div class="line"></div><div class="line">    <span class="keyword">auto</span> foo2 = [](<span class="keyword">int</span> x) </div><div class="line">    {</div><div class="line">        <span class="built_in">cout</span> &lt;&lt; x &lt;&lt; endl;</div><div class="line">    };</div><div class="line">    foo2(<span class="number">9</span>);  <span class="comment">// 9</span></div><div class="line"></div><div class="line">    <span class="keyword">int</span> y = <span class="number">2</span>;</div><div class="line">    <span class="keyword">auto</span> foo3 = [y](<span class="keyword">int</span> x)</div><div class="line">    {</div><div class="line">        <span class="built_in">cout</span> &lt;&lt; x * y &lt;&lt; endl;</div><div class="line">    };</div><div class="line">    foo3(<span class="number">5</span>);  <span class="comment">// 10</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p><code>[ capture ] ( params ) { body }</code> 是 lambda 表达式的基本写法。</p>
<p>C++ 中 lambda 表达式以 <code>[]</code> 开头，<code>[]</code> 称为 <em>capture specification</em> ，中括号中间的参数 capture 是我们希望捕获的外部引用参数。圆括号中的 params 是匿名函数的参数，而 body 即函数内容，符合 C++ 中一般函数的写法。</p>
<p><br></p>
<hr>
<h2 id="怎么用_lambda_表达式">怎么用 lambda 表达式</h2>
<p>上面的例子中我们用 <code>auto</code> 定义变量保存了 lambda 表达式定义的函数，然后就可以像普通函数一样进行调用。实际上还可以直接调用 lambda 表达式定义的匿名函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;iostream&gt;</span></div><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;string&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">int</span> main()</div><div class="line">{</div><div class="line">    <span class="built_in">string</span> my_name(<span class="string">"insaneguy"</span>);</div><div class="line">    [](<span class="keyword">const</span> <span class="built_in">string</span>& name) { <span class="built_in">cout</span> &lt;&lt; <span class="string">"My name is "</span> + name &lt;&lt; endl; } (my_name);</div><div class="line">    <span class="comment">// "My name is insaneguy"</span></div><div class="line"></div><div class="line">    <span class="keyword">int</span> n = [](<span class="keyword">int</span> x, <span class="keyword">int</span> y) { <span class="keyword">return</span> x + y; } (<span class="number">2</span>, <span class="number">3</span>);</div><div class="line">    <span class="built_in">cout</span> &lt;&lt; n &lt;&lt; endl;  <span class="comment">// 5</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>值得注意的是，lambda 表达式返回的实际上是一个匿名的<strong>函数对象(functor)</strong>，或者说是一个<strong>仿函数</strong>实例，而不是直接一个普通函数。因此我们可以将 lambda 表达式作为参数传入 STL 算法，下面举一个 <code>for_each</code> 的例子：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;iostream&gt;</span></div><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;vector&gt;</span></div><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;algorithm&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">int</span> main()</div><div class="line">{</div><div class="line">    <span class="stl_container"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;</span> numbers;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i)</div><div class="line">    {</div><div class="line">        numbers.push_back(i);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// print even numbers</span></div><div class="line">    for_each(numbers.begin(), numbers.end(), [](<span class="keyword">int</span> n) { </div><div class="line">        <span class="keyword">if</span> (n % <span class="number">2</span> == <span class="number">0</span>)</div><div class="line">        {</div><div class="line">            <span class="built_in">cout</span> &lt;&lt; n &lt;&lt; <span class="string">" "</span>;</div><div class="line">        }</div><div class="line">    });</div><div class="line">    <span class="built_in">cout</span> &lt;&lt; endl;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p><br></p>
<hr>
<h2 id="为什么要使用_lambda_表达式">为什么要使用 lambda 表达式</h2>
<p>前面举的例子都不能很好体现 lambda 表达式的优点。事实上，利用 lambda 表达式创建那些“只用一次”或者比较短小的函数非常方便和高效。</p>
<p>在编写 GUI (图形用户界面) 程序时，回调（callback）函数往往属于“用过就扔”的，即只在程序中与控件绑定一次，之后不会由用户显式地调用。传统的做法是把回调函数写成类的私有成员方法，现在我们可以使用 lambda 表达式来创建回调函数，既可以减少代码量，又能提高程序可读性。</p>
<h3 id="使用_lambda_表达式构造事件回调(callback)">使用 lambda 表达式构造事件回调(callback)</h3>
<p>下面举 <a href="http://www.cocos2d-x.org/" target="_blank" rel="external">Cocos2d-x 3.x</a> 中的控件事件监听绑定的例子。</p>
<h4 id="第一种方式：通过回调函数绑定的形式添加事件监听器">第一种方式：通过回调函数绑定的形式添加事件监听器</h4>
<p><code>HelloWorld</code> 是游戏的主场景层，其中有一个 <code>Label</code> 标签控件，我们希望点击标签弹出一个对话框。</p>
<p>首先要在 <code>HelloWorld</code> 类中定义一个回调方法 HelloWorld::touchBeganHandler() ：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// HelloWorldScene.h </span></div><div class="line"><span class="preprocessor">#<span class="keyword">include</span> "cocos2d.h"</span></div><div class="line"> </div><div class="line"><span class="keyword">class</span> HelloWorld : <span class="keyword">public</span> cocos2d::LayerColor</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="keyword">static</span> cocos2d::Scene* createScene();</div><div class="line"> </div><div class="line">    <span class="keyword">virtual</span> <span class="keyword">bool</span> init();</div><div class="line"> </div><div class="line">    <span class="comment">// 一个处理触摸（onTouchBegan）事件的回调(callback)方法</span></div><div class="line">    <span class="keyword">virtual</span> <span class="keyword">bool</span> touchBeganHandler(cocos2d::Touch*, cocos2d::Event*);</div><div class="line">    <span class="comment">// ...</span></div><div class="line">};</div></pre></td></tr></table></figure>



<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// HelloWorldScene.cpp</span></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="keyword">bool</span> HelloWorld::touchBeganHandler(Touch*, Event*)</div><div class="line">{</div><div class="line">    <span class="comment">// 弹出一个对话框</span></div><div class="line">    MessageBox(<span class="string">"touch began"</span>, <span class="string">"Title"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>然后在 <code>HelloWorld::init()</code> 中绑定事件监听器和回调方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// HelloWorldScene.cpp</span></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="keyword">bool</span> HelloWorld::init()</div><div class="line">{</div><div class="line">    <span class="comment">//...</span></div><div class="line">	</div><div class="line">    <span class="comment">// 创建一个 Label 控件并添加到当前层中</span></div><div class="line">    <span class="keyword">auto</span> label = Label::create();</div><div class="line">    label-&gt;setString(<span class="string">"Hello Cocos2d-x"</span>);</div><div class="line">    label-&gt;setPosition(visibleSize / <span class="number">2</span>);</div><div class="line">    addChild(label);</div><div class="line">   </div><div class="line">    <span class="comment">// 为 label 创建一个事件监听器，将 label 的 onTouchBegan 事件与</span></div><div class="line">    <span class="comment">// HelloWorld::touchBeganHandler() 回调方法进行绑定</span></div><div class="line">    <span class="keyword">auto</span> listener = EventListenerTouchOneByOne::create();</div><div class="line"></div><div class="line">    <span class="comment">// 利用 Cocos2d-x 中的宏绑定事件监听器与回调方法</span></div><div class="line">    listener-&gt;onTouchBegan = </div><div class="line">        CC_CALLBACK_2(HelloWorld::touchBeganHandler, <span class="keyword">this</span>);  </div><div class="line"></div><div class="line">    <span class="comment">// 为 label 控件添加事件监听器</span></div><div class="line">    Director::getInstance()-&gt;getEventDispatcher()-&gt;</div><div class="line">        addEventListenerWithSceneGraphPriority(listener, label);</div><div class="line"> </div><div class="line"> </div><div class="line">    <span class="comment">//...</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<h4 id="第二种方式：使用_C++_lambda_表达式的形式添加事件监听器">第二种方式：使用 C++ lambda 表达式的形式添加事件监听器</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// HelloWorldScene.cpp</span></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="keyword">bool</span> HelloWorld::init()</div><div class="line">{</div><div class="line">    <span class="comment">//...</span></div><div class="line">	</div><div class="line">    <span class="comment">// 创建一个 Label 并添加到当前层中</span></div><div class="line">    <span class="keyword">auto</span> label = Label::create();</div><div class="line">    label-&gt;setString(<span class="string">"Hello Cocos2d-x"</span>);</div><div class="line">    label-&gt;setPosition(visibleSize / <span class="number">2</span>);</div><div class="line">    addChild(label);</div><div class="line"></div><div class="line">    <span class="comment">// 创建一个事件监听器，通过 lambda 表达式创建一个匿名回调方法</span></div><div class="line">    <span class="comment">// 并与 listener 的 onTouchBegan 进行绑定</span></div><div class="line">    <span class="keyword">auto</span> listener = EventListenerTouchOneByOne::create();</div><div class="line">    listener-&gt;onTouchBegan = [](cocos2d::Touch*, cocos2d::Event* ) </div><div class="line">    {</div><div class="line">        MessageBox(<span class="string">"touch began"</span>, <span class="string">"Title"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    };</div><div class="line"></div><div class="line">    <span class="comment">//...</span></div><div class="line">	</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>直观上感受，使用 lambda 表达式的版本代码更少，逻辑清晰，代码的可读性高。</p>
<p>进一步来看，上面的例子中我们只为一个 <code>Label</code> 控件绑定了事件回调，该回调函数只“用”了一次，不需要重用，使用 lambda 表达式不需要额外为 <code>HelloWorld</code> 类添加一个成员方法，减少了类的名字空间被“污染”的可能性。</p>
<p>使用 lambda 表达式还可以帮助我们写出符合 <strong>DRY (Don’t Repeat Yourself)</strong> 的代码。</p>
<h4 id="使用_lambda_表达式编写_DRY_的代码">使用 lambda 表达式编写 <strong>DRY</strong> 的代码</h4>
<p>现在我们的 <code>HelloWorld</code> 场景中有四个控件，我们希望为这四个控件编写相同的事件处理。考虑如下代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// HelloWorldScene.h</span></div><div class="line"><span class="preprocessor">#<span class="keyword">include</span> "cocos2d.h"</span></div><div class="line"> </div><div class="line"><span class="keyword">class</span> HelloWorld : <span class="keyword">public</span> cocos2d::LayerColor</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="comment">//...</span></div><div class="line"> </div><div class="line"><span class="keyword">private</span>:</div><div class="line">    cocos2d::TextFieldTTF *aTf, *bTf;  <span class="comment">// 文本输入框控件</span></div><div class="line">    cocos2d::Label *aLabel, *bLabel;   <span class="comment">// 文本标签控件</span></div><div class="line">};</div></pre></td></tr></table></figure>



<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// HelloWorldScene.cpp</span></div><div class="line"><span class="comment">//...</span></div><div class="line"></div><div class="line"><span class="comment">// 为控件添加事件监听器的方法</span></div><div class="line"><span class="keyword">void</span> HelloWorld::addListeners()</div><div class="line">{</div><div class="line">    <span class="keyword">auto</span> director = Director::getInstance();  <span class="comment">// 获取 Director 类实例</span></div><div class="line"> </div><div class="line">    <span class="comment">// 使用 lambda 表达式实现 onTouchBegan 事件回调方法</span></div><div class="line">    <span class="comment">// 暂时未编写事件处理代码</span></div><div class="line">    <span class="keyword">auto</span> handler = [](Touch *t, Event *e) {</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    };</div><div class="line"> </div><div class="line">    <span class="comment">// 为输入框 aTf 添加事件监听</span></div><div class="line">    <span class="keyword">auto</span> aTfClickListener = EventListenerTouchOneByOne::create();</div><div class="line">    aTfClickListener-&gt;onTouchBegan = handler;</div><div class="line">    director-&gt;getEventDispatcher()-&gt;</div><div class="line">        addEventListenerWithSceneGraphPriority(aTfClickListener, aTf);</div><div class="line"> </div><div class="line">    <span class="comment">// 为输入框 bTf 添加事件监听</span></div><div class="line">    <span class="keyword">auto</span> bTfClickListener = EventListenerTouchOneByOne::create();</div><div class="line">    bTfClickListener-&gt;onTouchBegan = handler;</div><div class="line">    director-&gt;getEventDispatcher()-&gt;</div><div class="line">        addEventListenerWithSceneGraphPriority(bTfClickListener, bTf);</div><div class="line">	</div><div class="line">    <span class="comment">// 为 aLabel 添加事件监听</span></div><div class="line">    <span class="keyword">auto</span> aLabelListener = EventListenerTouchOneByOne::create();</div><div class="line">    aLabelListener-&gt;onTouchBegan = handler;</div><div class="line">    director-&gt;getEventDispatcher()-&gt;</div><div class="line">        addEventListenerWithSceneGraphPriority(aLabelListener, aLabel);</div><div class="line"></div><div class="line">    <span class="comment">// 为 bLabel 添加事件监听</span></div><div class="line">    <span class="keyword">auto</span> bLabelListener = EventListenerTouchOneByOne::create();</div><div class="line">    bLabelListener-&gt;onTouchBegan = handler;</div><div class="line">    director-&gt;getEventDispatcher()-&gt;</div><div class="line">        addEventListenerWithSceneGraphPriority(bLabelListener, bLabel);</div><div class="line">}</div></pre></td></tr></table></figure>

<p><code>HelloWorld::addListeners()</code> 方法中为不同控件添加事件监听的代码出现了明显的重复现象，我们可以使用 lambda 表达式来优化：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// HelloWorldScene.cpp</span></div><div class="line"><span class="comment">//...</span></div><div class="line"></div><div class="line"><span class="keyword">void</span> HelloWorld::addListeners()</div><div class="line">{</div><div class="line">    <span class="keyword">auto</span> director = Director::getInstance();  <span class="comment">// 获取 Director 类实例</span></div><div class="line"></div><div class="line">    <span class="comment">// 使用 lambda 表达式实现 onTouchBegan 事件回调函数</span></div><div class="line">    <span class="comment">// 暂时未编写事件处理代码</span></div><div class="line">    <span class="keyword">auto</span> handler = [=](Touch *t, Event *e) {</div><div class="line"> </div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    };</div><div class="line"> </div><div class="line">    <span class="comment">// 使用 lambda 表达式为控件添加事件监听</span></div><div class="line">    <span class="keyword">auto</span> addListenerToTarget = [director, handler](Node *target) {</div><div class="line">        <span class="keyword">auto</span> listener = EventListenerTouchOneByOne::create();</div><div class="line">        listener-&gt;onTouchBegan = handler;</div><div class="line">        director-&gt;getEventDispatcher()-&gt;</div><div class="line">            addEventListenerWithSceneGraphPriority(listener, target);</div><div class="line">    };</div><div class="line"> </div><div class="line">    addListenerToTarget(aTf);</div><div class="line">    addListenerToTarget(bTf);</div><div class="line">    addListenerToTarget(aLabel);</div><div class="line">    addListenerToTarget(bLabel);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>现在看起来舒服多了~</p>
<p>注意上面的代码中 <code>auto handler = [=](Touch *t, Event *e) {/*...*/}</code> 的 <code>[=]</code> 表示通过拷贝方式捕获所有外部引用变量。关于 lambda 表达式捕获外部变量的语法有如下几种：</p>
<ul>
<li><code>[]</code>  : 不捕获任何外部变量</li>
<li><code>[&amp;]</code>  : 通过引用方式捕获所有外部变量</li>
<li><code>[=]</code>  : 通过拷贝方式捕获所有外部变量</li>
<li><code>[=, &amp;foo]</code>  : 通过引用方式捕获 <code>foo</code> 变量，其他外部变量通过拷贝方式捕获</li>
<li><code>[bar]</code>  : 通过拷贝方式捕获 <code>bar</code> 变量</li>
<li><code>[this]</code>  : 捕获当前类的 <code>this</code> 指针</li>
</ul>
<p><br></p>
<hr>
<h2 id="参考资料">参考资料</h2>
<ol>
<li><a href="http://www.cprogramming.com/c++11/c++11-lambda-closures.html" target="_blank" rel="external">Lambda Functions in C++11 - the Definitive Guide</a></li>
<li><a href="https://msdn.microsoft.com/zh-cn/library/vstudio/dd293599" target="_blank" rel="external">Lambda表达式的示例-MSDN</a></li>
</ol>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/Programming/">Programming</a>, <a href="/categories/Programming/C/">C++</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/C/">C++</a>, <a href="/tags/lambda-expression/">lambda expression</a>
  </div>

        <div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_qzone" data-cmd="qzone"></a><a href="#" class="bds_tsina" data-cmd="tsina"></a><a href="#" class="bds_tqq" data-cmd="tqq"></a><a href="#" class="bds_renren" data-cmd="renren"></a><a href="#" class="bds_weixin" data-cmd="weixin"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdPic":"","bdStyle":"0","bdSize":"16"},"share":{},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["qzone","tsina","tqq","renren","weixin"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



 <nav id="pagination" >
    
    <a href="/2015/04/02/crop_pdf_with_OpenCV/" class="alignleft prev" >Prev</a>
    
    
    <a href="/2015/03/25/rotation_matrix_and_quaternions/" class="alignright next" >Next</a>
    
    <div class="clearfix"></div></nav>

<section id="comment">
<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="2015/03/30/lambda_expressions_in_cpp/" data-title="C++ 中的 lambda 表达式" data-url="http://insaneguy.me2015/03/30/lambda_expressions_in_cpp/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"insaneguy"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->

</section>

</div></div>
    <aside id="sidebar" class="alignright">
  
<div class="widget tag">
  <h3 class="title">Categories</h3>
  <ul class="entry">
  
    <li><a href="/categories/Programming/C/">C++</a><small>2</small></li>
  
    <li><a href="/categories/Diary/">Diary</a><small>1</small></li>
  
    <li><a href="/categories/Mathematics/">Mathematics</a><small>1</small></li>
  
    <li><a href="/categories/Programming/">Programming</a><small>15</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">Tags</h3>
  <ul class="entry">
  
    <li><a href="/tags/C/">C++</a><small>3</small></li>
  
    <li><a href="/tags/Image-Processing/">Image Processing</a><small>1</small></li>
  
    <li><a href="/tags/Kinect/">Kinect</a><small>1</small></li>
  
    <li><a href="/tags/OpenCV/">OpenCV</a><small>2</small></li>
  
    <li><a href="/tags/Ruby/">Ruby</a><small>4</small></li>
  
    <li><a href="/tags/Scala/">Scala</a><small>6</small></li>
  
    <li><a href="/tags/coursera/">coursera</a><small>6</small></li>
  
    <li><a href="/tags/fp/">fp</a><small>6</small></li>
  
    <li><a href="/tags/graphics/">graphics</a><small>1</small></li>
  
    <li><a href="/tags/hexo/">hexo</a><small>1</small></li>
  
    <li><a href="/tags/lambda-expression/">lambda expression</a><small>1</small></li>
  
    <li><a href="/tags/notes/">notes</a><small>7</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2015 insaneguy
  
</div>
<div class="clearfix"></div></footer>
  <script src="//libs.baidu.com/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            processEscapes: true
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


</body>
</html>

<a href="https://github.com/you"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/c6625ac1f3ee0a12250227cf83ce904423abf351/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_gray_6d6d6d.png"></a>